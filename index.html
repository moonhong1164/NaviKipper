<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KIPPER Ïπ¥Îìú ÎΩëÍ∏∞ | Ï†úÏûë : ÏõîÌôçüåô</title>
  <style>
    :root{
      /* ===== Light Mint on White ===== */
      --bg:#f7fffd;                 /* Í±∞Ïùò Ìù∞ ÎØºÌä∏ */
      --bg2:#ffffff;                /* ÏôÑÏ†Ñ Ìù∞ */
      --panel:#ffffffcc;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line: rgba(15,23,42,.10);

      --accent:#2dd4bf;            /* mint */
      --accentDeep:#14b8a6;        /* Îçî ÏßÑÌïú ÎØºÌä∏ */
      --accentSoft: rgba(45,212,191,.14);
      --danger:#fb7185;

      --shadow: 0 12px 40px rgba(15,23,42,.10);
      --radius2: 22px;
      --max: 1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      background:
        radial-gradient(1100px 520px at 22% 8%, rgba(45,212,191,.18), transparent 60%),
        radial-gradient(900px 460px at 78% 0%, rgba(20,184,166,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 92%, rgba(45,212,191,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width: var(--max); margin: 0 auto; padding: 22px 16px 40px;}

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 14px 8px 10px;
    }
    h1{margin:0; font-size:24px; letter-spacing:-.2px;}

    .bar{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
    }
    .seg{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}

    button{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      font-weight: 750;
      font-size: 13px;
      letter-spacing: -.1px;
      user-select:none;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
    }
    button:hover{
      background: #ffffff;
      border-color: rgba(20,184,166,.35);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    button:active{ transform: scale(.98); }

    button.primary{
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(45,212,191,.70));
      border-color: rgba(20,184,166,.45);
      color: #05201c;
      box-shadow: 0 12px 26px rgba(20,184,166,.18);
    }
    button.primary:hover{
      border-color: rgba(20,184,166,.60);
      box-shadow: 0 16px 34px rgba(20,184,166,.22);
    }

    button.ghost{
      background: rgba(255,255,255,.80);
    }

    button.danger{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.35);
      color:#9f1239;
      box-shadow: 0 10px 26px rgba(251,113,133,.10);
    }
    button.danger:hover{
      background: rgba(251,113,133,.16);
      border-color: rgba(251,113,133,.45);
    }

    button.active{
      outline: 2px solid rgba(20,184,166,.35);
      border-color: rgba(20,184,166,.55);
      background: rgba(45,212,191,.18);
    }

    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .stage{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    /* ====== Grid ====== */
    .grid{
      display:grid;
      justify-content:center;
      align-items:start;
      gap: 10px;
      --cardW: 120px;
    }
    .grid.basic{ grid-template-columns: repeat(auto-fit, minmax(var(--cardW), var(--cardW))); }
    .grid.nine{  grid-template-columns: repeat(3, minmax(var(--cardW), var(--cardW))); }
    .grid.gt{    grid-template-columns: repeat(9, minmax(var(--cardW), 1fr)); gap: 8px; }

    /* ====== Card ====== */
    .card{
      position:relative;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.90);
      box-shadow: 0 12px 30px rgba(15,23,42,.10);
      cursor:pointer;
      transition: transform .12s ease, border-color .15s ease, box-shadow .15s ease;
      width: var(--cardW);
      max-width: 100%;
      justify-self:center;
      aspect-ratio: 3 / 4.6; /* Îçú Í∏∏Ïñ¥ Î≥¥Ïù¥Í≤å */
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(20,184,166,.45);
      box-shadow: 0 16px 40px rgba(15,23,42,.12);
    }
    .card.selected{
      outline: 3px solid rgba(45,212,191,.35);
      border-color: rgba(20,184,166,.55);
    }
    .card img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: linear-gradient(180deg, rgba(45,212,191,.08), rgba(255,255,255,0));
    }

    .badge{
      position:absolute;
      top:8px; left:8px;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(15,23,42,.12);
      color: rgba(15,23,42,.86);
      backdrop-filter: blur(8px);
    }

    /* ===== Chain ===== */
    .chainBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--radius2);
      background: rgba(45,212,191,.10);
      border: 1px solid rgba(20,184,166,.18);
    }
    .chainTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap; margin-bottom: 10px;
    }
    .chainTitle{margin:0; font-size: 14px; font-weight: 950; letter-spacing: -.1px;}
    .chainMeta{color: var(--muted); font-size: 12px; line-height:1.35;}
    .chainRow{display:flex; gap:10px; overflow:auto; padding-bottom: 6px;}
    .chainRow::-webkit-scrollbar{ height:8px; }
    .chainRow::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.12); border-radius: 999px; }

    .mini{
      width: 92px; min-width: 92px;
      aspect-ratio: 3/4.6;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.90);
      box-shadow: 0 10px 24px rgba(15,23,42,.10);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mini img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: linear-gradient(180deg, rgba(45,212,191,.08), rgba(255,255,255,0));
    }
    .mini .badge{
      top:6px; left:6px;
      font-size: 10px; padding: 5px 7px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(15,23,42,.12);
      color: rgba(15,23,42,.86);
    }

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 24px 80px rgba(15,23,42,.18);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .modalInner{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 14px;
      padding: 14px;
      align-items:start;
    }
    .modalPreview{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.90);
      aspect-ratio: 3/4.6;
      box-shadow: 0 10px 26px rgba(15,23,42,.12);
    }
    .modalPreview img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: linear-gradient(180deg, rgba(45,212,191,.08), rgba(255,255,255,0));
    }
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .modalTitle{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: -.2px;
      line-height: 1.25;
      color: #0f172a;
    }
    .modalSub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .chipRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .chip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,184,166,.30);
      background: rgba(45,212,191,.14);
      color: #0f172a;
      font-weight: 800;
    }
    .modalFooter{
      padding: 10px 14px 14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
    }

    footer{
      margin-top: 18px;
      text-align:center;
      color: rgba(71,85,105,.9);
      font-size: 12px;
      padding: 10px 0 0;
    }

    @media (max-width: 980px){
      .grid.gt{ grid-template-columns: repeat(6, minmax(var(--cardW), 1fr)); }
    }
    @media (max-width: 640px){
      header{ flex-direction:column; align-items:flex-start; }
      .grid.gt{ grid-template-columns: repeat(4, minmax(var(--cardW), 1fr)); }
      .modalInner{ grid-template-columns: 1fr; }
      .modalPreview{ width: 170px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>ÌÇ§Ìçº Ïπ¥Îìú ÎΩëÍ∏∞</h1>
      <div class="rightTools">
        <button class="ghost" id="btnShuffle">ÏÉàÎ°ú ÏÑûÍ∏∞</button>
        <button class="danger" id="btnClear">Ï¥àÍ∏∞Ìôî</button>
      </div>
    </header>

    <section class="bar">
      <div class="controls">
        <div class="seg" id="spreadButtons">
          <button data-mode="1" class="active">1Ïπ¥Îìú</button>
          <button data-mode="2">2Ïπ¥Îìú</button>
          <button data-mode="3">3Ïπ¥Îìú</button>
          <button data-mode="9">9Ïπ¥Îìú</button>
          <button data-mode="gt">Í∑∏ÎûëÌÉÄÎ∏îÎ°ú(9√ó4)</button>
        </div>

        <div class="seg">
          <button class="ghost" id="btnChainLen" title="6~12 ÏÇ¨Ïù¥ ÏàúÌôò">Ï≤¥Ïù∏ Í∏∏Ïù¥: 8</button>
          <button class="primary" id="btnDraw">ÎΩëÍ∏∞</button>
        </div>
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="grid basic" id="grid"></div>

      <div class="chainBox" id="chainBox" style="display:none">
        <div class="chainTop">
          <div>
            <h3 class="chainTitle" id="chainTitle">Ï≤¥Ïù∏</h3>
            <div class="chainMeta" id="chainMeta"></div>
          </div>
        </div>
        <div class="chainRow" id="chainRow"></div>
      </div>
    </section>

    <footer>Ï†úÏûë : ÏõîÌôçüåô</footer>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalInner">
        <div class="modalPreview">
          <img id="modalImg" alt="card preview" />
        </div>
        <div>
          <div class="modalHeader">
            <div>
              <h2 class="modalTitle" id="modalTitle">Ïπ¥Îìú Ï†ïÎ≥¥</h2>
              <p class="modalSub" id="modalSub">‚Äî</p>
            </div>
            <button class="ghost" id="btnCloseModal">Îã´Í∏∞</button>
          </div>
          <div class="chipRow" id="modalChips"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="primary" id="btnOkModal">ÌôïÏù∏</button>
      </div>
    </div>
  </div>

<script>
  // =========================================
  // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎ™Ö/Í≤ΩÎ°ú ÏûêÎèôÌÉêÏÉâ(ÌëúÏãúÎäî Ïïà Ìï®)
  // =========================================
  const TOTAL = 36;
  const FILE_PREFIX = "ÌÇ§Ìçº-";
  const DIGITS = 3;
  const EXT = "png";

  const BASE_PATH_CANDIDATES = [
    "", "./", "img/", "images/", "image/", "assets/", "asset/",
    "cards/", "card/", "kipper/", "Kipper/", "KIPPER/",
    "img/kipper/", "images/kipper/", "assets/kipper/",
    "assets/img/", "assets/images/", "static/", "public/",
    "../", "../img/", "../images/", "../assets/",
  ];

  // =========================================
  // Ïπ¥ÎìúÎ™Ö/ÌÇ§ÏõåÎìú
  // =========================================
  const CARD_INFO = {
    1: { en:"Main significator, Male", ko:"Ï£ºÏöî Ïù∏Î¨º(ÎÇ®ÏÑ±)", kw:["Î≥∏Ïù∏/ÏÉÅÎåÄ ÎÇ®ÏÑ±","Ï£ºÏù∏Í≥µ","Ï§ëÏã¨ Ïù∏Î¨º"] },
    2: { en:"Main significator, Female", ko:"Ï£ºÏöî Ïù∏Î¨º(Ïó¨ÏÑ±)", kw:["Î≥∏Ïù∏/ÏÉÅÎåÄ Ïó¨ÏÑ±","Ï£ºÏù∏Í≥µ","Ï§ëÏã¨ Ïù∏Î¨º"] },
    3: { en:"State of marriage", ko:"Í≤∞Ìòº/Í¥ÄÍ≥Ñ ÏÉÅÌÉú", kw:["Í≥µÏãù Í¥ÄÍ≥Ñ","Í≥ÑÏïΩ/ÏïΩÏÜç","Ïú†ÎåÄÍ∞ê"] },
    4: { en:"Meeting", ko:"ÎßåÎÇ®/Î™®ÏûÑ", kw:["ÏÜåÍ∞ú","ÏïΩÏÜç","ÏÇ¨Íµê/ÎÑ§Ìä∏ÏõåÌÇπ"] },
    5: { en:"Good gentleman", ko:"ÏÑ±ÏàôÌïú ÎÇ®ÏÑ±(Ï¢ãÏùÄ Ïã†ÏÇ¨)", kw:["Î©òÌÜ†/ÏÉÅÏÇ¨","ÏïàÏ†ïÍ∞ê","Ïã†Î¢∞"] },
    6: { en:"Good lady", ko:"ÏÑ±ÏàôÌïú Ïó¨ÏÑ±(Ï¢ãÏùÄ ÏàôÎÖÄ)", kw:["Î≥¥Ìò∏/Î∞∞Î†§","ÏÑ±ÏàôÌï®","Ìò∏Ïùò"] },
    7: { en:"Letter", ko:"Ìé∏ÏßÄ/Ïó∞ÎùΩ", kw:["Î©îÏãúÏßÄ","ÏÜåÏãù","Î¨∏ÏÑú"] },
    8: { en:"False person", ko:"Í±∞ÏßìÎêú ÏÇ¨Îûå", kw:["Í∞ÄÎ©¥","ÏÜçÏûÑÏàò","ÏßÑÏã§ ÌôïÏù∏"] },
    9: { en:"Change", ko:"Î≥ÄÌôî", kw:["Ï†ÑÌôòÏ†ê","ÏÉÅÌô© Î≥ÄÎèô","ÌùêÎ¶Ñ Ïù¥Îèô"] },
    10:{ en:"Journey", ko:"Ïó¨Ìñâ/Ïù¥Îèô", kw:["Ï∂úÏû•/Ïù¥ÏÇ¨","Í±∞Î¶¨","Î∞©Ìñ• Ï†ÑÌôò"] },
    11:{ en:"Win lots of money", ko:"ÌÅ∞ Îèà/ÏàòÏùµ", kw:["ÎãπÏ≤®/Î≥¥ÎÑàÏä§","ÏàòÏûÖ Ï¶ùÍ∞Ä","Ïû¨Ï†ï Ìò∏Ïû¨"] },
    12:{ en:"Rich girl", ko:"Î∂ÄÏú†Ìïú Ïó¨ÏÑ±/ÌòúÌÉù", kw:["ÌäπÍ∂å","ÏßÄÏõê","ÌíçÏöî"] },
    13:{ en:"Young good lord", ko:"Ï†äÏùÄ ÎÇ®ÏÑ±/Ïú†Îä•Ìïú ÏÇ¨Îûå", kw:["Îä•Î†•","Í∏∞Ìöå","ÌïµÏã¨ Ïù∏Î¨º"] },
    14:{ en:"Sad news", ko:"ÎÇòÏÅú ÏÜåÏãù", kw:["Ïã§Îßù","Î∂àÎ¶¨Ìïú ÌÜµÎ≥¥","Í≤ΩÍ≥†"] },
    15:{ en:"Good outcome in love", ko:"ÏÇ¨ÎûëÏùò Ï¢ãÏùÄ Í≤∞Í≥º", kw:["Ìò∏Í∞ê","Í¥ÄÍ≥Ñ ÏßÑÏ†Ñ","ÏÑ±Í≥µ"] },
    16:{ en:"His thoughts", ko:"ÏÉùÍ∞Å/ÏÜçÎßàÏùå", kw:["Í≥ÑÌöç","Í¥ÄÏã¨","Í≥†ÎØº"] },
    17:{ en:"Receive a gift", ko:"ÏÑ†Î¨º/Ï†úÏïà", kw:["ÏßÄÏõê","Ìò∏Ïùò","Í∏∞Ìöå Ï†úÏãú"] },
    18:{ en:"A small child", ko:"ÏïÑÏù¥/Ï¥àÍ∏∞ Îã®Í≥Ñ", kw:["ÏÉà Ï∂úÎ∞ú","ÏàúÏàò","ÏÑ±Ïû•"] },
    19:{ en:"Fatality", ko:"Ïö¥Î™Ö/Ï¢ÖÍ≤∞", kw:["Í≤∞Ï†ïÏ†Å ÏÇ¨Í±¥","ÎßàÎ¨¥Î¶¨","ÌîºÌï† Ïàò ÏóÜÎäî ÌùêÎ¶Ñ"] },
    20:{ en:"House", ko:"Ïßë/Í∞ÄÏ†ï", kw:["Í±∞Ï≤ò","ÏïàÏ†ï","Í∞ÄÏ°± Í∏∞Î∞ò"] },
    21:{ en:"Living room", ko:"Í∞ÄÏ°±/Í≥µÍ∞Ñ(Í±∞Ïã§)", kw:["Í∞ÄÏ†ïÏÇ¨","ÏÉùÌôú","ÏπúÎ∞ÄÌïú ÏòÅÏó≠"] },
    22:{ en:"Military person", ko:"Íµ∞Ïù∏/Í≥µÍ∂åÎ†•", kw:["Í∑úÏú®","Í≥µÏãù Í∏∞Í¥Ä","Í∞ïÍ≤ΩÌï®"] },
    23:{ en:"Court of law", ko:"Î≤ïÏ†ï/ÌåêÎã®", kw:["ÌèâÍ∞Ä","Í≤∞Ï†ï","Í≥µÏãù Ï†àÏ∞®"] },
    24:{ en:"Theft", ko:"ÎèÑÎÇú/ÎπºÏïóÍπÄ", kw:["ÏÜêÏã§","ÎàÑÎùΩ","Ï£ºÏùò ÌïÑÏöî"] },
    25:{ en:"High honors", ko:"Î™ÖÏòà/ÏäπÏßÑ", kw:["Ïù∏Ï†ï","ÏÑ±Í≥º","Í≤©ÏÉÅ"] },
    26:{ en:"Great fortune", ko:"ÌÅ∞ ÌñâÏö¥", kw:["ÎåÄÏÑ±Í≥µ","Ï¢ãÏùÄ ÌùêÎ¶Ñ","Í∞ïÌïú Î≥¥Ìò∏"] },
    27:{ en:"Unhoped for money", ko:"ÎúªÎ∞ñÏùò Îèà", kw:["ÏòàÏÉÅ Î∞ñ ÏàòÏûÖ","Î≥¥ÏÉÅ","Í∏âÏ†Ñ"] },
    28:{ en:"Expectations", ko:"Í∏∞ÎåÄ/Ìù¨Îßù", kw:["Í∏∞Îã§Î¶º","Ï†ÑÎßù","Î™©Ìëú"] },
    29:{ en:"Prison", ko:"Í∞êÍ∏à/Ï†úÏïΩ", kw:["ÎßâÌûò","Ï†úÌïú","ÌÉàÏ∂úÍµ¨ ÌïÑÏöî"] },
    30:{ en:"Court official", ko:"Í≥µÎ¨¥Ïõê/Ï§ëÍ∞úÏûê", kw:["ÏÑúÎ•ò","Ï†àÏ∞®","Ï°∞Ïú®"] },
    31:{ en:"Short illness", ko:"Îã®Í∏∞ ÏïÑÌîî/Ìú¥Ïãù", kw:["Ïª®ÎîîÏÖò Ï†ÄÌïò","ÌöåÎ≥µ","Ïû†Íπê Î©àÏ∂§"] },
    32:{ en:"Sorrow and unpleasantness", ko:"Ïä¨Ìîî/Î∂àÌé∏", kw:["ÏÉÅÏ≤ò","Ïä§Ìä∏Î†àÏä§","Î∂àÏæå"] },
    33:{ en:"Gloomy thoughts", ko:"Ïö∞Ïö∏Ìïú ÏÉùÍ∞Å", kw:["Î∂àÏïà","ÎπÑÍ¥Ä","ÎßàÏùå Í¥ÄÎ¶¨"] },
    34:{ en:"Work and occupation", ko:"Ïùº/ÏßÅÏóÖ", kw:["ÏóÖÎ¨¥","ÎÖ∏Î†•","ÌòÑÏã§ Í≥ºÏ†ú"] },
    35:{ en:"Long road", ko:"Í∏¥ Í∏∏/Ïû•Í±∞Î¶¨", kw:["Ïû•Í∏∞Ï†Ñ","Î©ÄÎ¶¨ Î≥¥Í∏∞","ÏßÄÏÜç"] },
    36:{ en:"Great water, Hope", ko:"ÌÅ∞ Î¨º/Ìù¨Îßù", kw:["ÏπòÏú†","Í∞êÏ†ïÏùò ÌùêÎ¶Ñ","Ìù¨Îßù/ÏòÅÍ∞ê"] },
  };

  // =========================================
  // ÏÉÅÌÉú
  // =========================================
  let mode = "1";
  let deck = [];
  let basePath = null;

  let gt = null; // { cardsByHouse: number[37] }
  let CHAIN_LEN = 8;

  // =========================================
  // DOM
  // =========================================
  const grid = document.getElementById("grid");
  const spreadButtons = document.getElementById("spreadButtons");
  const btnDraw = document.getElementById("btnDraw");
  const btnShuffle = document.getElementById("btnShuffle");
  const btnClear = document.getElementById("btnClear");
  const btnChainLen = document.getElementById("btnChainLen");

  const chainBox = document.getElementById("chainBox");
  const chainRow = document.getElementById("chainRow");
  const chainTitle = document.getElementById("chainTitle");
  const chainMeta = document.getElementById("chainMeta");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalImg = document.getElementById("modalImg");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalChips = document.getElementById("modalChips");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnOkModal = document.getElementById("btnOkModal");

  // =========================================
  // Ïú†Ìã∏
  // =========================================
  function pad(n, digits){
    const s = String(n);
    return s.length >= digits ? s : "0".repeat(digits - s.length) + s;
  }
  function fileName(cardNo){
    return `${FILE_PREFIX}${pad(cardNo, DIGITS)}.${EXT}`;
  }
  function imgSrc(cardNo){
    const bp = basePath ?? "";
    return `${bp}${fileName(cardNo)}`;
  }
  function shuffle(arr){
    for(let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function freshDeck(){
    deck = Array.from({length: TOTAL}, (_,i)=>i+1);
    shuffle(deck);
  }
  function take(n){
    if(deck.length < n) freshDeck();
    return deck.splice(0,n);
  }
  function checkImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=> resolve(true);
      img.onerror = ()=> resolve(false);
      img.src = url + (url.includes("?") ? "" : `?v=${Date.now()}`);
    });
  }
  async function autoDetectBasePath(){
    const sample = fileName(1);
    for(const p of BASE_PATH_CANDIDATES){
      const ok = await checkImage(`${p}${sample}`);
      if(ok){ basePath = p; return true; }
    }
    basePath = "";
    return false;
  }

  // =========================================
  // Ïπ¥Îìú ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†à
  // =========================================
  function setCardWidth(px){
    grid.style.setProperty("--cardW", `${px}px`);
  }
  function applyResponsiveCardSize(){
    const w = Math.min(window.innerWidth, 1100);
    if(mode === "gt"){
      if(w >= 980) setCardWidth(100);
      else if(w >= 720) setCardWidth(92);
      else setCardWidth(86);
      return;
    }
    if(mode === "9"){
      if(w >= 980) setCardWidth(120);
      else if(w >= 720) setCardWidth(112);
      else setCardWidth(98);
      return;
    }
    if(w >= 980) setCardWidth(140);
    else if(w >= 720) setCardWidth(128);
    else setCardWidth(110);
  }

  // =========================================
  // Modal
  // =========================================
  function openModal(cardNo, extraLine=""){
    const info = CARD_INFO[cardNo] || { ko:"(Ï†ïÎ≥¥ ÏóÜÏùå)", en:"", kw:[] };
    modalImg.src = imgSrc(cardNo);
    modalTitle.textContent = `${cardNo}. ${info.ko}`;
    modalSub.textContent = `${info.en}${extraLine ? " ¬∑ " + extraLine : ""}`;

    modalChips.innerHTML = "";
    (info.kw || []).forEach(k=>{
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = k;
      modalChips.appendChild(chip);
    });

    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
  }
  btnCloseModal.addEventListener("click", closeModal);
  btnOkModal.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

  // =========================================
  // Î†åÎçî
  // =========================================
  function createCardEl(cardNo, label){
    const el = document.createElement("div");
    el.className = "card";
    el.dataset.card = String(cardNo);

    const img = document.createElement("img");
    img.src = imgSrc(cardNo);
    img.alt = `Card ${cardNo}`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = label;

    el.appendChild(img);
    el.appendChild(badge);

    el.addEventListener("click", ()=>{
      if(mode !== "gt") openModal(cardNo);
    });

    return el;
  }

  function clearStageOnly(){
    grid.innerHTML = "";
    chainRow.innerHTML = "";
    chainBox.style.display = "none";
    gt = null;
  }

  function setMode(newMode){
    mode = newMode;

    [...spreadButtons.querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.dataset.mode === mode);
    });

    grid.className = "grid";
    if(mode === "9") grid.classList.add("nine");
    else if(mode === "gt") grid.classList.add("gt");
    else grid.classList.add("basic");

    applyResponsiveCardSize();
    clearStageOnly();
  }

  function renderBasic(cards){
    grid.innerHTML = "";
    cards.forEach((no, idx)=>{
      grid.appendChild(createCardEl(no, `${idx+1}`));
    });
  }

  // =========================================
  // Í∑∏ÎûëÌÉÄÎ∏îÎ°ú 9x4: ÌïòÏö∞Ïä§/Ï≤¥Ïù∏
  // =========================================
  function buildGrandTableau(cards36){
    const cardsByHouse = Array(37).fill(0);
    for(let house=1; house<=36; house++){
      cardsByHouse[house] = cards36[house-1];
    }
    return { cardsByHouse };
  }

  function buildHouseChain(gtState, startHouse, len){
    const chain = [];
    const seenHouses = new Set();
    let currentHouse = startHouse;

    while(chain.length < len){
      if(currentHouse < 1 || currentHouse > 36) break;
      if(seenHouses.has(currentHouse)) break;
      seenHouses.add(currentHouse);

      const card = gtState.cardsByHouse[currentHouse];
      chain.push({ house: currentHouse, card });

      currentHouse = card;
    }
    return chain;
  }

  function renderChain(chain){
    chainRow.innerHTML = "";
    if(chain.length === 0){
      chainTitle.textContent = "Ï≤¥Ïù∏";
      chainMeta.textContent = "";
      return;
    }
    const start = chain[0];
    chainTitle.textContent = `Ï≤¥Ïù∏ (ÏãúÏûë: H${start.house})`;
    chainMeta.textContent = `H${start.house} ‚Üí H${start.card} ‚Üí ‚Ä¶ (Í∏∏Ïù¥ ${chain.length}, ÏÑ§Ï†ï ${CHAIN_LEN})`;

    chain.forEach((step)=>{
      const mini = document.createElement("div");
      mini.className = "mini";

      const img = document.createElement("img");
      img.src = imgSrc(step.card);
      img.alt = `Chain ${step.card}`;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `H${step.house}`;

      mini.appendChild(img);
      mini.appendChild(badge);

      mini.addEventListener("click", ()=>{
        openModal(step.card, `Ï≤¥Ïù∏: H${step.house}`);
      });

      chainRow.appendChild(mini);
    });
  }

  function renderGrandTableau(gtState){
    grid.innerHTML = "";
    chainBox.style.display = "block";
    chainRow.innerHTML = "";
    chainTitle.textContent = "Ï≤¥Ïù∏";
    chainMeta.textContent = "";

    for(let house=1; house<=36; house++){
      const cardNo = gtState.cardsByHouse[house];
      const el = createCardEl(cardNo, `H${house}`);
      el.dataset.house = String(house);

      el.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        document.querySelectorAll(".card.selected").forEach(x=>x.classList.remove("selected"));
        el.classList.add("selected");

        const chain = buildHouseChain(gtState, house, CHAIN_LEN);
        renderChain(chain);

        openModal(cardNo, `ÌïòÏö∞Ïä§ H${house}`);
      });

      grid.appendChild(el);
    }
  }

  // =========================================
  // ÎΩëÍ∏∞
  // =========================================
  function draw(){
    clearStageOnly();

    if(mode === "gt"){
      const cards = take(36);
      gt = buildGrandTableau(cards);
      renderGrandTableau(gt);
      return;
    }

    const n = Number(mode);
    renderBasic(take(n));
  }

  // =========================================
  // Ïù¥Î≤§Ìä∏
  // =========================================
  spreadButtons.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    setMode(btn.dataset.mode);
  });

  btnDraw.addEventListener("click", draw);
  btnShuffle.addEventListener("click", ()=> freshDeck());
  btnClear.addEventListener("click", ()=> clearStageOnly());

  btnChainLen.addEventListener("click", ()=>{
    CHAIN_LEN = CHAIN_LEN >= 12 ? 6 : CHAIN_LEN + 1;
    btnChainLen.textContent = `Ï≤¥Ïù∏ Í∏∏Ïù¥: ${CHAIN_LEN}`;
  });

  window.addEventListener("resize", applyResponsiveCardSize);

  // =========================================
  // Ï¥àÍ∏∞Ìôî
  // =========================================
  (async function init(){
    btnChainLen.textContent = `Ï≤¥Ïù∏ Í∏∏Ïù¥: ${CHAIN_LEN}`;
    freshDeck();
    setMode("1");
    await autoDetectBasePath(); // ÎÇ¥Î∂Ä ÌÉêÏÉâÎßå
  })();
</script>
</body>
</html>
