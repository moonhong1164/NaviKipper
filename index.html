<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KIPPER ì¹´ë“œ ë½‘ê¸° | ì œì‘ : ì›”í™ğŸŒ™</title>
  <style>
    :root{
      /* ===== Mint Theme ===== */
      --bg:#06121a;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text:#eafffb;
      --muted: rgba(234,255,251,.72);
      --line: rgba(255,255,255,.14);

      --accent:#2dd4bf;     /* mint */
      --accent2:#34d399;    /* mint-green */
      --danger:#fb7185;

      --shadow: 0 14px 50px rgba(0,0,0,.48);
      --radius: 18px;
      --radius2: 22px;
      --max: 1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      background:
        radial-gradient(1100px 520px at 25% 10%, rgba(45,212,191,.35), transparent 60%),
        radial-gradient(900px 460px at 75% 0%, rgba(52,211,153,.22), transparent 60%),
        radial-gradient(900px 520px at 70% 85%, rgba(45,212,191,.14), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width: var(--max); margin: 0 auto; padding: 22px 16px 40px;}

    header{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; padding: 14px 8px 10px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{margin:0; font-size:24px; letter-spacing:-.2px;}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.35;}

    .bar{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
    }
    .seg{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}

    button{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-weight: 750;
      font-size: 13px;
      letter-spacing: -.1px;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: scale(.98); }
    button.primary{
      background: linear-gradient(135deg, rgba(45,212,191,.92), rgba(45,212,191,.55));
      border-color: rgba(45,212,191,.60);
    }
    button.ghost{ background: rgba(255,255,255,.04); }
    button.danger{
      background: rgba(251,113,133,.18);
      border-color: rgba(251,113,133,.45);
    }
    button.active{
      outline: 2px solid rgba(45,212,191,.65);
      border-color: rgba(45,212,191,.65);
      background: rgba(45,212,191,.18);
    }

    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      padding: 0 4px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding: 6px 10px;
      border-radius:999px;
      font-size:12px;
      color: rgba(234,255,251,.80);
    }
    .pill.ok{ border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.12); }
    .pill.bad{ border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12); }

    .stage{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }

    .grid{display:grid; gap: 10px; justify-content:center; align-items:start;}
    .grid.basic{ grid-template-columns: repeat(auto-fit, minmax(120px, 120px)); }
    .grid.nine{ grid-template-columns: repeat(3, minmax(110px, 130px)); }
    .grid.gt{ grid-template-columns: repeat(9, minmax(78px, 1fr)); gap: 8px; }

    .card{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      cursor:pointer;
      transition: transform .12s ease, border-color .15s ease, background .15s ease;
      aspect-ratio: 3 / 5;
      max-width: 140px;
      width: 100%;
      justify-self:center;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(45,212,191,.70); }
    .card.selected{
      outline: 3px solid rgba(52,211,153,.78);
      border-color: rgba(52,211,153,.78);
    }
    .card img{ width:100%; height:100%; object-fit:cover; display:block; }

    .badge{
      position:absolute;
      top:8px; left:8px;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.20);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
    }

    /* ===== Chain ===== */
    .chainBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
    }
    .chainTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap; margin-bottom: 10px;
    }
    .chainTitle{margin:0; font-size: 14px; font-weight: 900; letter-spacing: -.1px;}
    .chainMeta{color: var(--muted); font-size: 12px; line-height:1.35;}
    .chainRow{display:flex; gap:10px; overflow:auto; padding-bottom: 6px;}
    .chainRow::-webkit-scrollbar{ height:8px; }
    .chainRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; }

    .mini{
      width: 92px; min-width: 92px;
      aspect-ratio: 3/5;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      position:relative;
    }
    .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini .badge{ top:6px; left:6px; font-size: 10px; padding: 5px 7px; }

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: rgba(9, 24, 33, .92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .modalInner{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 14px;
      padding: 14px;
      align-items:start;
    }
    .modalPreview{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      aspect-ratio: 3/5;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .modalPreview img{width:100%; height:100%; object-fit:cover; display:block;}
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .modalTitle{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: -.2px;
      line-height: 1.25;
    }
    .modalSub{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .chipRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .chip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(45,212,191,.45);
      background: rgba(45,212,191,.10);
      color: rgba(234,255,251,.92);
      font-weight: 750;
    }
    .modalFooter{
      padding: 10px 14px 14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }

    footer{
      margin-top: 18px;
      text-align:center;
      color: rgba(234,255,251,.62);
      font-size: 12px;
      padding: 10px 0 0;
    }

    @media (max-width: 980px){
      .grid.gt{ grid-template-columns: repeat(6, minmax(78px, 1fr)); }
    }
    @media (max-width: 720px){
      .modalInner{ grid-template-columns: 140px 1fr; }
    }
    @media (max-width: 640px){
      .grid.gt{ grid-template-columns: repeat(4, minmax(78px, 1fr)); }
      header{ flex-direction:column; align-items:flex-start; }
      .grid.nine{ grid-template-columns: repeat(3, minmax(86px, 1fr)); }
      .card{ max-width: 120px; }
      .modalInner{ grid-template-columns: 1fr; }
      .modalPreview{ width: 170px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>í‚¤í¼ ì¹´ë“œ ë½‘ê¸°</h1>
        <p class="sub">
          1/2/3/9ì¹´ë“œ Â· ê·¸ë‘íƒ€ë¸”ë¡œ(9Ã—4).<br/>
          <b>ê·¸ë‘íƒ€ë¸”ë¡œ: ì¹´ë“œ í´ë¦­ â†’ í•˜ìš°ìŠ¤ ì²´ì¸ ìƒì„±</b> + ì¹´ë“œëª…/í‚¤ì›Œë“œ í‘œì‹œ
        </p>
      </div>
      <div class="rightTools">
        <button class="ghost" id="btnRescan">ì´ë¯¸ì§€ ê²½ë¡œ ì¬íƒìƒ‰</button>
        <button class="ghost" id="btnShuffle">ìƒˆë¡œ ì„ê¸°</button>
        <button class="danger" id="btnClear">ì´ˆê¸°í™”</button>
      </div>
    </header>

    <section class="bar">
      <div class="controls">
        <div class="seg" id="spreadButtons">
          <button data-mode="1" class="active">1ì¹´ë“œ</button>
          <button data-mode="2">2ì¹´ë“œ</button>
          <button data-mode="3">3ì¹´ë“œ</button>
          <button data-mode="9">9ì¹´ë“œ</button>
          <button data-mode="gt">ê·¸ë‘íƒ€ë¸”ë¡œ(9Ã—4)</button>
        </div>

        <div class="seg">
          <button class="primary" id="btnDraw">ë½‘ê¸°</button>
        </div>
      </div>

      <div class="hint" id="hint">
        <span class="pill" id="pathPill">ì´ë¯¸ì§€ ê²½ë¡œ íƒìƒ‰ ì¤‘â€¦</span>
        <span class="pill" id="filePill">íŒŒì¼ëª…: í‚¤í¼-001.png ~ í‚¤í¼-036.png</span>
        <span class="pill" id="modePill">í˜„ì¬ ëª¨ë“œ: 1ì¹´ë“œ</span>
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="grid basic" id="grid"></div>

      <div class="chainBox" id="chainBox" style="display:none">
        <div class="chainTop">
          <div>
            <h3 class="chainTitle" id="chainTitle">ì²´ì¸</h3>
            <div class="chainMeta" id="chainMeta">
              ê·¸ë‘íƒ€ë¸”ë¡œì—ì„œ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì²´ì¸ì´ ìƒì„±ë©ë‹ˆë‹¤.
            </div>
          </div>
          <div class="seg">
            <button class="ghost" id="btnChainLen">ì²´ì¸ ê¸¸ì´: 8</button>
          </div>
        </div>
        <div class="chainRow" id="chainRow"></div>
      </div>
    </section>

    <footer>ì œì‘ : ì›”í™ğŸŒ™</footer>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalInner">
        <div class="modalPreview">
          <img id="modalImg" alt="card preview" />
        </div>
        <div>
          <div class="modalHeader">
            <div>
              <h2 class="modalTitle" id="modalTitle">ì¹´ë“œ ì •ë³´</h2>
              <p class="modalSub" id="modalSub">â€”</p>
            </div>
            <button class="ghost" id="btnCloseModal">ë‹«ê¸°</button>
          </div>
          <div class="chipRow" id="modalChips"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="primary" id="btnOkModal">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
  // =========================================
  // ì´ë¯¸ì§€ íŒŒì¼ëª…/ê²½ë¡œ ìë™íƒìƒ‰
  // =========================================
  const TOTAL = 36;
  const FILE_PREFIX = "í‚¤í¼-";
  const DIGITS = 3;
  const EXT = "png";

  const BASE_PATH_CANDIDATES = [
    "", "./", "img/", "images/", "image/", "assets/", "asset/",
    "cards/", "card/", "kipper/", "Kipper/", "KIPPER/",
    "img/kipper/", "images/kipper/", "assets/kipper/",
    "assets/img/", "assets/images/", "static/", "public/",
    "../", "../img/", "../images/", "../assets/",
  ];

  // =========================================
  // Kipper ì¹´ë“œëª…/í‚¤ì›Œë“œ (ë²ˆí˜¸ëŠ” Stefan's Cards ê¸°ì¤€) :contentReference[oaicite:1]{index=1}
  // =========================================
  const CARD_INFO = {
    1: { en:"Main significator, Male", ko:"ì£¼ìš” ì¸ë¬¼(ë‚¨ì„±)", kw:["ë³¸ì¸/ìƒëŒ€ ë‚¨ì„±","ì£¼ì¸ê³µ","ì¤‘ì‹¬ ì¸ë¬¼"] },
    2: { en:"Main significator, Female", ko:"ì£¼ìš” ì¸ë¬¼(ì—¬ì„±)", kw:["ë³¸ì¸/ìƒëŒ€ ì—¬ì„±","ì£¼ì¸ê³µ","ì¤‘ì‹¬ ì¸ë¬¼"] },
    3: { en:"State of marriage", ko:"ê²°í˜¼/ê´€ê³„ ìƒíƒœ", kw:["ê³µì‹ ê´€ê³„","ê³„ì•½/ì•½ì†","ìœ ëŒ€ê°"] },
    4: { en:"Meeting", ko:"ë§Œë‚¨/ëª¨ì„", kw:["ì†Œê°œ","ì•½ì†","ì‚¬êµ/ë„¤íŠ¸ì›Œí‚¹"] },
    5: { en:"Good gentleman", ko:"ì„±ìˆ™í•œ ë‚¨ì„±(ì¢‹ì€ ì‹ ì‚¬)", kw:["ë©˜í† /ìƒì‚¬","ì•ˆì •ê°","ì‹ ë¢°"] },
    6: { en:"Good lady", ko:"ì„±ìˆ™í•œ ì—¬ì„±(ì¢‹ì€ ìˆ™ë…€)", kw:["ë³´í˜¸/ë°°ë ¤","ì„±ìˆ™í•¨","í˜¸ì˜"] },
    7: { en:"Letter", ko:"í¸ì§€/ì—°ë½", kw:["ë©”ì‹œì§€","ì†Œì‹","ë¬¸ì„œ"] },
    8: { en:"False person", ko:"ê±°ì§“ëœ ì‚¬ëŒ", kw:["ê°€ë©´","ì†ì„ìˆ˜","ì§„ì‹¤ í™•ì¸"] },
    9: { en:"Change", ko:"ë³€í™”", kw:["ì „í™˜ì ","ìƒí™© ë³€ë™","íë¦„ ì´ë™"] },
    10:{ en:"Journey", ko:"ì—¬í–‰/ì´ë™", kw:["ì¶œì¥/ì´ì‚¬","ê±°ë¦¬","ë°©í–¥ ì „í™˜"] },
    11:{ en:"Win lots of money", ko:"í° ëˆ/ìˆ˜ìµ", kw:["ë‹¹ì²¨/ë³´ë„ˆìŠ¤","ìˆ˜ì… ì¦ê°€","ì¬ì • í˜¸ì¬"] },
    12:{ en:"Rich girl", ko:"ë¶€ìœ í•œ ì—¬ì„±/í˜œíƒ", kw:["íŠ¹ê¶Œ","ì§€ì›","í’ìš”"] },
    13:{ en:"Young good lord", ko:"ì Šì€ ë‚¨ì„±/ìœ ëŠ¥í•œ ì‚¬ëŒ", kw:["ëŠ¥ë ¥","ê¸°íšŒ","í•µì‹¬ ì¸ë¬¼"] },
    14:{ en:"Sad news", ko:"ë‚˜ìœ ì†Œì‹", kw:["ì‹¤ë§","ë¶ˆë¦¬í•œ í†µë³´","ê²½ê³ "] },
    15:{ en:"Good outcome in love", ko:"ì‚¬ë‘ì˜ ì¢‹ì€ ê²°ê³¼", kw:["í˜¸ê°","ê´€ê³„ ì§„ì „","ì„±ê³µ"] },
    16:{ en:"His thoughts", ko:"ìƒê°/ì†ë§ˆìŒ", kw:["ê³„íš","ê´€ì‹¬","ê³ ë¯¼"] },
    17:{ en:"Receive a gift", ko:"ì„ ë¬¼/ì œì•ˆ", kw:["ì§€ì›","í˜¸ì˜","ê¸°íšŒ ì œì‹œ"] },
    18:{ en:"A small child", ko:"ì•„ì´/ì´ˆê¸° ë‹¨ê³„", kw:["ìƒˆ ì¶œë°œ","ìˆœìˆ˜","ì„±ì¥"] },
    19:{ en:"Fatality", ko:"ìš´ëª…/ì¢…ê²°", kw:["ê²°ì •ì  ì‚¬ê±´","ë§ˆë¬´ë¦¬","í”¼í•  ìˆ˜ ì—†ëŠ” íë¦„"] },
    20:{ en:"House", ko:"ì§‘/ê°€ì •", kw:["ê±°ì²˜","ì•ˆì •","ê°€ì¡± ê¸°ë°˜"] },
    21:{ en:"Living room", ko:"ê°€ì¡±/ê³µê°„(ê±°ì‹¤)", kw:["ê°€ì •ì‚¬","ìƒí™œ","ì¹œë°€í•œ ì˜ì—­"] },
    22:{ en:"Military person", ko:"êµ°ì¸/ê³µê¶Œë ¥", kw:["ê·œìœ¨","ê³µì‹ ê¸°ê´€","ê°•ê²½í•¨"] },
    23:{ en:"Court of law", ko:"ë²•ì •/íŒë‹¨", kw:["í‰ê°€","ê²°ì •","ê³µì‹ ì ˆì°¨"] },
    24:{ en:"Theft", ko:"ë„ë‚œ/ë¹¼ì•—ê¹€", kw:["ì†ì‹¤","ëˆ„ë½","ì£¼ì˜ í•„ìš”"] },
    25:{ en:"High honors", ko:"ëª…ì˜ˆ/ìŠ¹ì§„", kw:["ì¸ì •","ì„±ê³¼","ê²©ìƒ"] },
    26:{ en:"Great fortune", ko:"í° í–‰ìš´", kw:["ëŒ€ì„±ê³µ","ì¢‹ì€ íë¦„","ê°•í•œ ë³´í˜¸"] },
    27:{ en:"Unhoped for money", ko:"ëœ»ë°–ì˜ ëˆ", kw:["ì˜ˆìƒ ë°– ìˆ˜ì…","ë³´ìƒ","ê¸‰ì „"] },
    28:{ en:"Expectations", ko:"ê¸°ëŒ€/í¬ë§", kw:["ê¸°ë‹¤ë¦¼","ì „ë§","ëª©í‘œ"] },
    29:{ en:"Prison", ko:"ê°ê¸ˆ/ì œì•½", kw:["ë§‰í˜","ì œí•œ","íƒˆì¶œêµ¬ í•„ìš”"] },
    30:{ en:"Court official", ko:"ê³µë¬´ì›/ì¤‘ê°œì", kw:["ì„œë¥˜","ì ˆì°¨","ì¡°ìœ¨"] },
    31:{ en:"Short illness", ko:"ë‹¨ê¸° ì•„í””/íœ´ì‹", kw:["ì»¨ë””ì…˜ ì €í•˜","íšŒë³µ","ì ê¹ ë©ˆì¶¤"] },
    32:{ en:"Sorrow and unpleasantness", ko:"ìŠ¬í””/ë¶ˆí¸", kw:["ìƒì²˜","ìŠ¤íŠ¸ë ˆìŠ¤","ë¶ˆì¾Œ"] },
    33:{ en:"Gloomy thoughts", ko:"ìš°ìš¸í•œ ìƒê°", kw:["ë¶ˆì•ˆ","ë¹„ê´€","ë§ˆìŒ ê´€ë¦¬"] },
    34:{ en:"Work and occupation", ko:"ì¼/ì§ì—…", kw:["ì—…ë¬´","ë…¸ë ¥","í˜„ì‹¤ ê³¼ì œ"] },
    35:{ en:"Long road", ko:"ê¸´ ê¸¸/ì¥ê±°ë¦¬", kw:["ì¥ê¸°ì „","ë©€ë¦¬ ë³´ê¸°","ì§€ì†"] },
    36:{ en:"Great water, Hope", ko:"í° ë¬¼/í¬ë§", kw:["ì¹˜ìœ ","ê°ì •ì˜ íë¦„","í¬ë§/ì˜ê°"] },
  };

  // =========================================
  // ìƒíƒœ
  // =========================================
  let mode = "1";
  let deck = [];
  let basePath = null;

  let gt = null; // { cardsByHouse: number[37], houseByCard: number[37] }
  let CHAIN_LEN = 8;

  // =========================================
  // DOM
  // =========================================
  const grid = document.getElementById("grid");
  const spreadButtons = document.getElementById("spreadButtons");
  const btnDraw = document.getElementById("btnDraw");
  const btnShuffle = document.getElementById("btnShuffle");
  const btnClear = document.getElementById("btnClear");
  const btnRescan = document.getElementById("btnRescan");
  const btnChainLen = document.getElementById("btnChainLen");

  const chainBox = document.getElementById("chainBox");
  const chainRow = document.getElementById("chainRow");
  const chainTitle = document.getElementById("chainTitle");
  const chainMeta = document.getElementById("chainMeta");

  const pathPill = document.getElementById("pathPill");
  const modePill = document.getElementById("modePill");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalImg = document.getElementById("modalImg");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalChips = document.getElementById("modalChips");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnOkModal = document.getElementById("btnOkModal");

  // =========================================
  // ìœ í‹¸
  // =========================================
  function pad(n, digits){
    const s = String(n);
    return s.length >= digits ? s : "0".repeat(digits - s.length) + s;
  }
  function fileName(cardNo){
    return `${FILE_PREFIX}${pad(cardNo, DIGITS)}.${EXT}`;
  }
  function imgSrc(cardNo){
    const bp = basePath ?? "";
    return `${bp}${fileName(cardNo)}`;
  }
  function shuffle(arr){
    for(let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function freshDeck(){
    deck = Array.from({length: TOTAL}, (_,i)=>i+1);
    shuffle(deck);
  }
  function take(n){
    if(deck.length < n) freshDeck();
    return deck.splice(0,n);
  }

  function checkImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=> resolve(true);
      img.onerror = ()=> resolve(false);
      img.src = url + (url.includes("?") ? "" : `?v=${Date.now()}`);
    });
  }

  async function autoDetectBasePath(){
    pathPill.textContent = "ì´ë¯¸ì§€ ê²½ë¡œ íƒìƒ‰ ì¤‘â€¦";
    pathPill.className = "pill";
    const sample = fileName(1);

    for(const p of BASE_PATH_CANDIDATES){
      const url = `${p}${sample}`;
      const ok = await checkImage(url);
      if(ok){
        basePath = p;
        pathPill.textContent = `ì´ë¯¸ì§€ ê²½ë¡œ OK: "${basePath}"`;
        pathPill.className = "pill ok";
        return true;
      }
    }
    basePath = "";
    pathPill.textContent = `ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ëª» ì°¾ì•˜ì–´ìš” (ì¬íƒìƒ‰/í´ë”ëª… í™•ì¸)`;
    pathPill.className = "pill bad";
    return false;
  }

  // =========================================
  // Modal
  // =========================================
  function openModal(cardNo, extraLine=""){
    const info = CARD_INFO[cardNo] || { ko:"(ì •ë³´ ì—†ìŒ)", en:"", kw:[] };
    modalImg.src = imgSrc(cardNo);
    modalTitle.textContent = `${cardNo}. ${info.ko}`;
    modalSub.textContent = `${info.en}${extraLine ? " Â· " + extraLine : ""}`;

    modalChips.innerHTML = "";
    (info.kw || []).forEach(k=>{
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = k;
      modalChips.appendChild(chip);
    });

    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
  }

  btnCloseModal.addEventListener("click", closeModal);
  btnOkModal.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{
    if(e.target === modalBackdrop) closeModal();
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeModal();
  });

  // =========================================
  // ë Œë”
  // =========================================
  function createCardEl(cardNo, indexLabel){
    const el = document.createElement("div");
    el.className = "card";
    el.dataset.card = String(cardNo);

    const img = document.createElement("img");
    img.src = imgSrc(cardNo);
    img.alt = `Card ${cardNo}`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = indexLabel;

    el.appendChild(img);
    el.appendChild(badge);

    // ê³µí†µ: ì¹´ë“œ í´ë¦­ ì‹œ ì¹´ë“œëª…/í‚¤ì›Œë“œ
    el.addEventListener("click", ()=>{
      // GTì—ì„œëŠ” ì²´ì¸ë„ ê°™ì´ ì²˜ë¦¬í•˜ë¯€ë¡œ, GT í´ë¦­ í•¸ë“¤ëŸ¬ì—ì„œ openModalì„ í˜¸ì¶œí•¨
      if(mode !== "gt") openModal(cardNo);
    });

    return el;
  }

  function clearStageOnly(){
    grid.innerHTML = "";
    chainRow.innerHTML = "";
    chainBox.style.display = "none";
    gt = null;
  }

  function setMode(newMode){
    mode = newMode;

    [...spreadButtons.querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.dataset.mode === mode);
    });

    const nameMap = { "1":"1ì¹´ë“œ", "2":"2ì¹´ë“œ", "3":"3ì¹´ë“œ", "9":"9ì¹´ë“œ", "gt":"ê·¸ë‘íƒ€ë¸”ë¡œ(9Ã—4)" };
    modePill.textContent = `í˜„ì¬ ëª¨ë“œ: ${nameMap[mode]}`;

    grid.className = "grid";
    if(mode === "9") grid.classList.add("nine");
    else if(mode === "gt") grid.classList.add("gt");
    else grid.classList.add("basic");

    clearStageOnly();
  }

  function renderBasic(cards){
    grid.innerHTML = "";
    cards.forEach((no, idx)=>{
      const el = createCardEl(no, `${idx+1}`);
      grid.appendChild(el);
    });
  }

  // =========================================
  // ê·¸ë‘íƒ€ë¸”ë¡œ 9x4: í•˜ìš°ìŠ¤ / ì²´ì¸
  // =========================================
  function buildGrandTableau(cards36){
    // house: 1..36 (ì™¼->ì˜¤, ìœ„->ì•„ë˜)
    const cardsByHouse = Array(37).fill(0);
    const houseByCard = Array(37).fill(0);

    for(let house=1; house<=36; house++){
      const card = cards36[house-1];
      cardsByHouse[house] = card;
      houseByCard[card] = house;
    }
    return { cardsByHouse, houseByCard };
  }

  function renderGrandTableau(gtState){
    grid.innerHTML = "";
    chainBox.style.display = "block";
    chainRow.innerHTML = "";
    chainTitle.textContent = "ì²´ì¸ (í•˜ìš°ìŠ¤ ê¸°ë°˜)";
    chainMeta.textContent = "ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´: ì‹œì‘ í•˜ìš°ìŠ¤ â†’ (ê·¸ í•˜ìš°ìŠ¤ì˜ ì¹´ë“œ ë²ˆí˜¸) í•˜ìš°ìŠ¤ë¡œ ì´ë™â€¦ ë°©ì‹ìœ¼ë¡œ ì²´ì¸ì´ ì´ì–´ì§‘ë‹ˆë‹¤.";

    for(let house=1; house<=36; house++){
      const cardNo = gtState.cardsByHouse[house];
      const el = createCardEl(cardNo, `H${house}`);
      el.dataset.house = String(house);

      el.addEventListener("click", (ev)=>{
        // ê¸°ë³¸ í´ë¦­ ëª¨ë‹¬ ë°©ì§€(ì¤‘ë³µ ë°©ì§€)
        ev.stopPropagation();

        document.querySelectorAll(".card.selected").forEach(x=>x.classList.remove("selected"));
        el.classList.add("selected");

        // í•˜ìš°ìŠ¤ ê¸°ë°˜ ì²´ì¸ ìƒì„±
        const startHouse = house;
        const chain = buildHouseChain(gtState, startHouse, CHAIN_LEN);
        renderChain(chain);

        // ì¹´ë“œ ì •ë³´ ëª¨ë‹¬ (í•˜ìš°ìŠ¤ ì •ë³´ ê°™ì´)
        openModal(cardNo, `í•˜ìš°ìŠ¤ H${house}`);
      });

      grid.appendChild(el);
    }
  }

  function buildHouseChain(gtState, startHouse, len){
    // ê·œì¹™:
    // í˜„ì¬ í•˜ìš°ìŠ¤ Hì— ìˆëŠ” ì¹´ë“œ = C
    // ë‹¤ìŒ í•˜ìš°ìŠ¤ = C (ì¹´ë“œ ë²ˆí˜¸)
    // ë°˜ë³µ (ë£¨í”„ ë°©ì§€: ê°™ì€ í•˜ìš°ìŠ¤ ì¬ë“±ì¥ ì‹œ ì¤‘ë‹¨)
    const chain = [];
    const seenHouses = new Set();

    let currentHouse = startHouse;

    while(chain.length < len){
      if(currentHouse < 1 || currentHouse > 36) break;
      if(seenHouses.has(currentHouse)) break;
      seenHouses.add(currentHouse);

      const card = gtState.cardsByHouse[currentHouse];
      chain.push({ house: currentHouse, card });

      const nextHouse = card; // í•µì‹¬: ì¹´ë“œ ë²ˆí˜¸ë¥¼ í•˜ìš°ìŠ¤ ë²ˆí˜¸ë¡œ
      currentHouse = nextHouse;
    }

    return chain;
  }

  function renderChain(chain){
    chainRow.innerHTML = "";

    if(chain.length === 0){
      chainMeta.textContent = "ì²´ì¸ì„ ë§Œë“¤ ìˆ˜ ì—†ì–´ìš”. (ë°ì´í„° ì˜¤ë¥˜)";
      return;
    }

    const start = chain[0];
    chainTitle.textContent = `ì²´ì¸ (ì‹œì‘: H${start.house})`;
    chainMeta.textContent = `H${start.house}ì˜ ì¹´ë“œ(${start.card}) â†’ ë‹¤ìŒ í•˜ìš°ìŠ¤(H${start.card})â€¦ (ê¸¸ì´ ${chain.length}, ì„¤ì • ${CHAIN_LEN})`;

    chain.forEach((step, idx)=>{
      const mini = document.createElement("div");
      mini.className = "mini";

      const img = document.createElement("img");
      img.src = imgSrc(step.card);
      img.alt = `Chain ${step.card}`;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = idx === 0 ? `H${step.house}` : `H${step.house}`;

      mini.appendChild(img);
      mini.appendChild(badge);

      // ì²´ì¸ ë¯¸ë‹ˆ í´ë¦­ ì‹œë„ ì¹´ë“œ ì •ë³´ ì—´ê¸°
      mini.addEventListener("click", ()=>{
        openModal(step.card, `ì²´ì¸: H${step.house}`);
      });

      chainRow.appendChild(mini);
    });
  }

  // =========================================
  // ë½‘ê¸°
  // =========================================
  function draw(){
    clearStageOnly();

    if(mode === "gt"){
      const cards = take(36);
      gt = buildGrandTableau(cards);
      renderGrandTableau(gt);
      return;
    }

    const n = Number(mode);
    const cards = take(n);
    renderBasic(cards);
  }

  // =========================================
  // ì´ë²¤íŠ¸
  // =========================================
  spreadButtons.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    setMode(btn.dataset.mode);
  });

  btnDraw.addEventListener("click", draw);
  btnShuffle.addEventListener("click", ()=> freshDeck());
  btnClear.addEventListener("click", ()=> clearStageOnly());

  btnRescan.addEventListener("click", async ()=>{
    await autoDetectBasePath();
    // í™”ë©´ì— ë– ìˆëŠ” ì¹´ë“œ ì´ë¯¸ì§€ ê°±ì‹ 
    document.querySelectorAll(".card").forEach(cardEl=>{
      const cardNo = Number(cardEl.dataset.card || "0");
      const img = cardEl.querySelector("img");
      if(cardNo && img) img.src = imgSrc(cardNo);
    });
    document.querySelectorAll(".mini").forEach(mini=>{
      const img = mini.querySelector("img");
      const alt = img?.alt || "";
      const m = alt.match(/Chain\s+(\d+)/);
      if(m && img) img.src = imgSrc(Number(m[1]));
    });
  });

  btnChainLen.addEventListener("click", ()=>{
    // 6~12 ì‚¬ì´ë¡œ ìˆœí™˜
    CHAIN_LEN = CHAIN_LEN >= 12 ? 6 : CHAIN_LEN + 1;
    btnChainLen.textContent = `ì²´ì¸ ê¸¸ì´: ${CHAIN_LEN}`;
    // í˜„ì¬ ì²´ì¸ì€ ìœ ì§€(ì›í•˜ë©´ í´ë¦­í•´ì„œ ìƒˆë¡œ ìƒì„±)
    chainMeta.textContent = `ì²´ì¸ ê¸¸ì´ë¥¼ ${CHAIN_LEN}ë¡œ ì„¤ì •í–ˆì–´ìš”. ê·¸ë‘íƒ€ë¸”ë¡œì—ì„œ ì¹´ë“œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ìƒˆ ê¸¸ì´ë¡œ ì²´ì¸ì´ ìƒì„±ë©ë‹ˆë‹¤.`;
  });

  // =========================================
  // ì´ˆê¸°í™”
  // =========================================
  (async function init(){
    btnChainLen.textContent = `ì²´ì¸ ê¸¸ì´: ${CHAIN_LEN}`;
    freshDeck();
    setMode("1");
    await autoDetectBasePath();
  })();
</script>
</body>
</html>
