<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KIPPER ì¹´ë“œ ë½‘ê¸° | ì œì‘ : ì›”í™ğŸŒ™</title>

  <style>
    :root{
      --bg:#FCF9EA;

      --panel:#ffffffcc;
      --text:#0f172a;
      --muted:#475569;
      --line: rgba(15,23,42,.10);

      --accent:#2dd4bf;
      --accentDeep:#14b8a6;
      --danger:#fb7185;

      --shadow: 0 12px 40px rgba(15,23,42,.10);
      --radius2: 18px;

      /* ì¹´ë“œ ë¹„ìœ¨ (PNG ë¹„ìœ¨ê³¼ ë§ì¶°ì„œ â€œì•ˆ ì˜ë¦¬ê³ â€ ê½‰ ì°¨ê²Œ) */
      --ar: 4.6; /* height = width * (4.6/3) */
    }

    *{box-sizing:border-box}
    html, body{height:100%}

    body{
      margin:0;
      overflow:hidden; /* ìŠ¤í¬ë¡¤ ì—†ìŒ */
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      background:
        radial-gradient(1200px 520px at 18% 8%, rgba(45,212,191,.18), transparent 60%),
        radial-gradient(900px 460px at 82% 0%, rgba(20,184,166,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 92%, rgba(45,212,191,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .wrap{
      height: 100vh;
      width: 100%;
      margin: 0;
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    header{
      flex: 0 0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 2px 0;
    }
    h1{margin:0; font-size:18px; letter-spacing:-.2px;}
    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .bar{
      flex: 0 0 auto;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 8px;
      backdrop-filter: blur(10px);
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center; justify-content:space-between;
    }
    .seg{display:flex; flex-wrap:wrap; gap:7px; align-items:center;}

    button{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      font-weight: 760;
      font-size: 12px;
      letter-spacing: -.1px;
      user-select:none;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      white-space: nowrap;
    }
    button:hover{
      background:#fff;
      border-color: rgba(20,184,166,.35);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    button:active{transform:scale(.98)}
    button.primary{
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(45,212,191,.70));
      border-color: rgba(20,184,166,.45);
      color: #05201c;
      box-shadow: 0 12px 26px rgba(20,184,166,.18);
    }
    button.primary:hover{
      border-color: rgba(20,184,166,.60);
      box-shadow: 0 16px 34px rgba(20,184,166,.22);
    }
    button.ghost{background: rgba(255,255,255,.82)}
    button.danger{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.35);
      color:#9f1239;
      box-shadow: 0 10px 26px rgba(251,113,133,.10);
    }
    button.active{
      outline: 2px solid rgba(20,184,166,.35);
      border-color: rgba(20,184,166,.55);
      background: rgba(45,212,191,.18);
    }

    .questionBox{
      margin-top: 8px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .qLabel{font-size: 11.5px; color: var(--muted); font-weight: 850; padding-left: 2px;}
    .qInput{
      flex: 1 1 320px;
      min-width: 180px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
    }
    .qInput:focus{
      border-color: rgba(20,184,166,.55);
      box-shadow: 0 10px 24px rgba(20,184,166,.14);
    }

    /* âœ… stage: ë‚´ë¶€ padding 0 (ì¹´ë“œê°€ â€œë¶™ì„â€ ê³µê°„ í™•ë³´) */
    .stage{
      flex: 1 1 auto;
      min-height: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 0;            /* í•µì‹¬ */
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      gap:0;
      overflow:hidden;
    }

    /* âœ… grid: â€œì¹¸ ì—¬ë°±â€ ìì²´ê°€ ìƒê¸°ì§€ ì•Šê²Œ í”½ì…€ íŠ¸ë™ì„ JSë¡œ ì„¤ì • */
    .grid{
      flex: 1 1 auto;
      min-height: 0;
      width:100%;
      height:100%;
      display:grid;
      gap:0;                 /* ì¹´ë“œ ê°„ê²© 0 */
      overflow:hidden;
      align-content:start;
      justify-content:start;
      /* JSê°€ ì•„ë˜ë¥¼ ì„¸íŒ…:
         grid-template-columns / rows
      */
    }

    /* âœ… ì¹´ë“œ: í° ë°•ìŠ¤/í…Œë‘ë¦¬/ê·¸ë¦¼ì ì œê±° + ì…€ 100% */
    .card{
      position:relative;
      width:100%;
      height:100%;
      border: none;
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      overflow:hidden;
      cursor:pointer;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }

    /* âœ… ì˜ë¦¼ ë°©ì§€(=contain) + ì¹´ë“œê°€ ì…€ì„ ê½‰ ì±„ìš°ë„ë¡(ì…€ ìì²´ê°€ ì¹´ë“œ ë¹„ìœ¨) */
    .card img{
      width:100%;
      height:100%;
      object-fit: contain;     /* ì•ˆ ì˜ë¦¼ */
      object-position:center;
      display:block;
    }

    .badge{
      position:absolute;
      top:6px; left:6px;
      font-size: 10px;
      font-weight: 900;
      padding: 4px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(15,23,42,.12);
      color: rgba(15,23,42,.86);
      backdrop-filter: blur(8px);
      pointer-events:none;
    }
    .card.selected{
      outline: 3px solid rgba(45,212,191,.28);
    }

    /* âœ… ì²´ì¸: GTì—ì„œ ì¹´ë“œ í´ë¦­í•´ì•¼ë§Œ ë“±ì¥ */
    .chainBox{
      flex: 0 0 auto;
      display:none;
      padding: 8px;
      border-top: 1px solid rgba(15,23,42,.08);
      background: rgba(45,212,191,.07);
      overflow:hidden;
    }
    .chainTop{display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap; margin-bottom: 6px;}
    .chainTitle{margin:0; font-size: 12.5px; font-weight: 950;}
    .chainMeta{color: var(--muted); font-size: 11px; line-height:1.35;}
    .chainRow{display:flex; gap:8px; overflow-x:auto; overflow-y:hidden; padding-bottom: 4px;}

    .mini{
      width: 58px; min-width: 58px;
      aspect-ratio: 3/4.6;
      border-radius: 0;
      overflow:hidden;
      border:none;
      background: transparent;
      box-shadow: none;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mini img{ width:100%; height:100%; object-fit:contain; display:block; }
    .mini .badge{ top:4px; left:4px; font-size: 9px; padding: 3px 5px; }

    footer{
      flex: 0 0 auto;
      text-align:center;
      color: rgba(71,85,105,.9);
      font-size: 11.5px;
      padding: 2px 0 0;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 24px 80px rgba(15,23,42,.18);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .modalInner{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 14px;
      padding: 14px;
      align-items:start;
    }
    .modalPreview{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.90);
      aspect-ratio: 3/4.6;
      box-shadow: 0 10px 26px rgba(15,23,42,.12);
    }
    .modalPreview img{ width:100%; height:100%; object-fit:contain; display:block; }
    .modalHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom: 8px; }
    .modalTitle{ margin:0; font-size: 16px; font-weight: 950; letter-spacing: -.2px; line-height: 1.25; color: #0f172a; }
    .modalSub{ margin:6px 0 0; color: var(--muted); font-size: 12px; line-height: 1.45; }
    .chipRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,184,166,.30);
      background: rgba(45,212,191,.14);
      color: #0f172a;
      font-weight: 800;
    }
    .modalFooter{
      padding: 10px 14px 14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
    }

    @media (max-width: 720px){
      header{ flex-direction:column; align-items:flex-start; }
      .modalInner{ grid-template-columns: 1fr; }
      .modalPreview{ width: 170px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>í‚¤í¼ ì¹´ë“œ ë½‘ê¸°</h1>
      <div class="rightTools">
        <button class="ghost" id="btnShuffle">ìƒˆë¡œ ì„ê¸°</button>
        <button class="danger" id="btnClear">ì´ˆê¸°í™”</button>
      </div>
    </header>

    <section class="bar">
      <div class="controls">
        <div class="seg" id="spreadButtons">
          <button data-mode="1" class="active">1ì¹´ë“œ</button>
          <button data-mode="2">2ì¹´ë“œ</button>
          <button data-mode="3">3ì¹´ë“œ</button>
          <button data-mode="9">9ì¹´ë“œ</button>
          <button data-mode="gt">ê·¸ë‘íƒ€ë¸”ë¡œ(9Ã—4)</button>
        </div>
        <div class="seg">
          <button class="primary" id="btnDraw">ë½‘ê¸°</button>
        </div>
      </div>

      <div class="questionBox">
        <div class="qLabel">ì§ˆë¬¸</div>
        <input id="questionInput" class="qInput" type="text" placeholder="ì˜ˆ) ê·¸ ì‚¬ëŒì˜ ì†ë§ˆìŒì€? / ì´ë²ˆ ë‹¬ ê¸ˆì „ íë¦„ì€?" />
        <button class="ghost" id="btnSaveQuestion">ì €ì¥</button>
        <button class="ghost" id="btnClearQuestion">ì§€ìš°ê¸°</button>
      </div>
    </section>

    <section class="stage" id="stage">
      <!-- âœ… ì²« í™”ë©´ ì¹´ë“œ ì•ˆ ë³´ì„(ë½‘ê¸° ëˆŒëŸ¬ì•¼ë§Œ í‘œì‹œ) -->
      <div class="grid" id="grid"></div>

      <div class="chainBox" id="chainBox">
        <div class="chainTop">
          <div>
            <h3 class="chainTitle" id="chainTitle">ì²´ì¸</h3>
            <div class="chainMeta" id="chainMeta"></div>
          </div>
        </div>
        <div class="chainRow" id="chainRow"></div>
      </div>
    </section>

    <footer>ì œì‘ : ì›”í™ğŸŒ™</footer>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalInner">
        <div class="modalPreview">
          <img id="modalImg" alt="card preview" />
        </div>
        <div>
          <div class="modalHeader">
            <div>
              <h2 class="modalTitle" id="modalTitle">ì¹´ë“œ ì •ë³´</h2>
              <p class="modalSub" id="modalSub">â€”</p>
            </div>
            <button class="ghost" id="btnCloseModal">ë‹«ê¸°</button>
          </div>
          <div class="chipRow" id="modalChips"></div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="primary" id="btnOkModal">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
  const TOTAL = 36;
  const FILE_PREFIX = "í‚¤í¼-";
  const DIGITS = 3;
  const EXT = "png";

  /* âœ… ì–´ë””ì— ë„£ì–´ë„ ìë™ íƒìƒ‰ */
  const BASE_PATH_CANDIDATES = [
    "", "./", "img/", "images/", "image/", "assets/", "asset/",
    "cards/", "card/", "kipper/", "Kipper/", "KIPPER/",
    "img/kipper/", "images/kipper/", "assets/kipper/",
    "assets/img/", "assets/images/", "static/", "public/",
    "../", "../img/", "../images/", "../assets/",
  ];

  const CARD_INFO = {
    1: { en:"Main significator, Male", ko:"ì£¼ìš” ì¸ë¬¼(ë‚¨ì„±)", kw:["ë³¸ì¸/ìƒëŒ€ ë‚¨ì„±","ì£¼ì¸ê³µ","ì¤‘ì‹¬ ì¸ë¬¼"] },
    2: { en:"Main significator, Female", ko:"ì£¼ìš” ì¸ë¬¼(ì—¬ì„±)", kw:["ë³¸ì¸/ìƒëŒ€ ì—¬ì„±","ì£¼ì¸ê³µ","ì¤‘ì‹¬ ì¸ë¬¼"] },
    3: { en:"State of marriage", ko:"ê²°í˜¼/ê´€ê³„ ìƒíƒœ", kw:["ê³µì‹ ê´€ê³„","ê³„ì•½/ì•½ì†","ìœ ëŒ€ê°"] },
    4: { en:"Meeting", ko:"ë§Œë‚¨/ëª¨ì„", kw:["ì†Œê°œ","ì•½ì†","ì‚¬êµ/ë„¤íŠ¸ì›Œí‚¹"] },
    5: { en:"Good gentleman", ko:"ì„±ìˆ™í•œ ë‚¨ì„±(ì¢‹ì€ ì‹ ì‚¬)", kw:["ë©˜í† /ìƒì‚¬","ì•ˆì •ê°","ì‹ ë¢°"] },
    6: { en:"Good lady", ko:"ì„±ìˆ™í•œ ì—¬ì„±(ì¢‹ì€ ìˆ™ë…€)", kw:["ë³´í˜¸/ë°°ë ¤","ì„±ìˆ™í•¨","í˜¸ì˜"] },
    7: { en:"Letter", ko:"í¸ì§€/ì—°ë½", kw:["ë©”ì‹œì§€","ì†Œì‹","ë¬¸ì„œ"] },
    8: { en:"False person", ko:"ê±°ì§“ëœ ì‚¬ëŒ", kw:["ê°€ë©´","ì†ì„ìˆ˜","ì§„ì‹¤ í™•ì¸"] },
    9: { en:"Change", ko:"ë³€í™”", kw:["ì „í™˜ì ","ìƒí™© ë³€ë™","íë¦„ ì´ë™"] },
    10:{ en:"Journey", ko:"ì—¬í–‰/ì´ë™", kw:["ì¶œì¥/ì´ì‚¬","ê±°ë¦¬","ë°©í–¥ ì „í™˜"] },
    11:{ en:"Win lots of money", ko:"í° ëˆ/ìˆ˜ìµ", kw:["ë‹¹ì²¨/ë³´ë„ˆìŠ¤","ìˆ˜ì… ì¦ê°€","ì¬ì • í˜¸ì¬"] },
    12:{ en:"Rich girl", ko:"ë¶€ìœ í•œ ì—¬ì„±/í˜œíƒ", kw:["íŠ¹ê¶Œ","ì§€ì›","í’ìš”"] },
    13:{ en:"Young good lord", ko:"ì Šì€ ë‚¨ì„±/ìœ ëŠ¥í•œ ì‚¬ëŒ", kw:["ëŠ¥ë ¥","ê¸°íšŒ","í•µì‹¬ ì¸ë¬¼"] },
    14:{ en:"Sad news", ko:"ë‚˜ìœ ì†Œì‹", kw:["ì‹¤ë§","ë¶ˆë¦¬í•œ í†µë³´","ê²½ê³ "] },
    15:{ en:"Good outcome in love", ko:"ì‚¬ë‘ì˜ ì¢‹ì€ ê²°ê³¼", kw:["í˜¸ê°","ê´€ê³„ ì§„ì „","ì„±ê³µ"] },
    16:{ en:"His thoughts", ko:"ìƒê°/ì†ë§ˆìŒ", kw:["ê³„íš","ê´€ì‹¬","ê³ ë¯¼"] },
    17:{ en:"Receive a gift", ko:"ì„ ë¬¼/ì œì•ˆ", kw:["ì§€ì›","í˜¸ì˜","ê¸°íšŒ ì œì‹œ"] },
    18:{ en:"A small child", ko:"ì•„ì´/ì´ˆê¸° ë‹¨ê³„", kw:["ìƒˆ ì¶œë°œ","ìˆœìˆ˜","ì„±ì¥"] },
    19:{ en:"Fatality", ko:"ìš´ëª…/ì¢…ê²°", kw:["ê²°ì •ì  ì‚¬ê±´","ë§ˆë¬´ë¦¬","í”¼í•  ìˆ˜ ì—†ëŠ” íë¦„"] },
    20:{ en:"House", ko:"ì§‘/ê°€ì •", kw:["ê±°ì²˜","ì•ˆì •","ê°€ì¡± ê¸°ë°˜"] },
    21:{ en:"Living room", ko:"ê°€ì¡±/ê³µê°„(ê±°ì‹¤)", kw:["ê°€ì •ì‚¬","ìƒí™œ","ì¹œë°€í•œ ì˜ì—­"] },
    22:{ en:"Military person", ko:"êµ°ì¸/ê³µê¶Œë ¥", kw:["ê·œìœ¨","ê³µì‹ ê¸°ê´€","ê°•ê²½í•¨"] },
    23:{ en:"Court of law", ko:"ë²•ì •/íŒë‹¨", kw:["í‰ê°€","ê²°ì •","ê³µì‹ ì ˆì°¨"] },
    24:{ en:"Theft", ko:"ë„ë‚œ/ë¹¼ì•—ê¹€", kw:["ì†ì‹¤","ëˆ„ë½","ì£¼ì˜ í•„ìš”"] },
    25:{ en:"High honors", ko:"ëª…ì˜ˆ/ìŠ¹ì§„", kw:["ì¸ì •","ì„±ê³¼","ê²©ìƒ"] },
    26:{ en:"Great fortune", ko:"í° í–‰ìš´", kw:["ëŒ€ì„±ê³µ","ì¢‹ì€ íë¦„","ê°•í•œ ë³´í˜¸"] },
    27:{ en:"Unhoped for money", ko:"ëœ»ë°–ì˜ ëˆ", kw:["ì˜ˆìƒ ë°– ìˆ˜ì…","ë³´ìƒ","ê¸‰ì „"] },
    28:{ en:"Expectations", ko:"ê¸°ëŒ€/í¬ë§", kw:["ê¸°ë‹¤ë¦¼","ì „ë§","ëª©í‘œ"] },
    29:{ en:"Prison", ko:"ê°ê¸ˆ/ì œì•½", kw:["ë§‰í˜","ì œí•œ","íƒˆì¶œêµ¬ í•„ìš”"] },
    30:{ en:"Court official", ko:"ê³µë¬´ì›/ì¤‘ê°œì", kw:["ì„œë¥˜","ì ˆì°¨","ì¡°ìœ¨"] },
    31:{ en:"Short illness", ko:"ë‹¨ê¸° ì•„í””/íœ´ì‹", kw:["ì»¨ë””ì…˜ ì €í•˜","íšŒë³µ","ì ê¹ ë©ˆì¶¤"] },
    32:{ en:"Sorrow and unpleasantness", ko:"ìŠ¬í””/ë¶ˆí¸", kw:["ìƒì²˜","ìŠ¤íŠ¸ë ˆìŠ¤","ë¶ˆì¾Œ"] },
    33:{ en:"Gloomy thoughts", ko:"ìš°ìš¸í•œ ìƒê°", kw:["ë¶ˆì•ˆ","ë¹„ê´€","ë§ˆìŒ ê´€ë¦¬"] },
    34:{ en:"Work and occupation", ko:"ì¼/ì§ì—…", kw:["ì—…ë¬´","ë…¸ë ¥","í˜„ì‹¤ ê³¼ì œ"] },
    35:{ en:"Long road", ko:"ê¸´ ê¸¸/ì¥ê±°ë¦¬", kw:["ì¥ê¸°ì „","ë©€ë¦¬ ë³´ê¸°","ì§€ì†"] },
    36:{ en:"Great water, Hope", ko:"í° ë¬¼/í¬ë§", kw:["ì¹˜ìœ ","ê°ì •ì˜ íë¦„","í¬ë§/ì˜ê°"] },
  };

  let mode = "1";
  let deck = [];
  let basePath = "";
  let gt = null;

  const grid = document.getElementById("grid");
  const stage = document.getElementById("stage");

  const spreadButtons = document.getElementById("spreadButtons");
  const btnDraw = document.getElementById("btnDraw");
  const btnShuffle = document.getElementById("btnShuffle");
  const btnClear = document.getElementById("btnClear");

  const chainBox = document.getElementById("chainBox");
  const chainRow = document.getElementById("chainRow");
  const chainTitle = document.getElementById("chainTitle");
  const chainMeta = document.getElementById("chainMeta");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalImg = document.getElementById("modalImg");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalChips = document.getElementById("modalChips");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnOkModal = document.getElementById("btnOkModal");

  const qInput = document.getElementById("questionInput");
  const btnSaveQuestion = document.getElementById("btnSaveQuestion");
  const btnClearQuestion = document.getElementById("btnClearQuestion");

  const AR = 4.6 / 3; // height = width * AR

  function pad(n, digits){
    const s = String(n);
    return s.length >= digits ? s : "0".repeat(digits - s.length) + s;
  }
  function fileName(cardNo){ return `${FILE_PREFIX}${pad(cardNo, DIGITS)}.${EXT}`; }
  function imgSrc(cardNo){ return `${basePath}${fileName(cardNo)}`; }

  function shuffle(arr){
    for(let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function freshDeck(){
    deck = Array.from({length: TOTAL}, (_,i)=>i+1);
    shuffle(deck);
  }
  function take(n){
    if(deck.length < n) freshDeck();
    return deck.splice(0,n);
  }

  function checkImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=> resolve(true);
      img.onerror = ()=> resolve(false);
      img.src = url + (url.includes("?") ? "" : `?v=${Date.now()}`);
    });
  }
  async function autoDetectBasePath(){
    const sample = fileName(1);
    for(const p of BASE_PATH_CANDIDATES){
      const ok = await checkImage(`${p}${sample}`);
      if(ok){ basePath = p; return true; }
    }
    basePath = "";
    return false;
  }

  /* ì§ˆë¬¸ ì €ì¥ */
  const Q_KEY = "navikipper_question_final";
  function loadQuestion(){ qInput.value = localStorage.getItem(Q_KEY) || ""; }
  function saveQuestion(){ localStorage.setItem(Q_KEY, qInput.value.trim()); }
  function clearQuestion(){ qInput.value = ""; localStorage.removeItem(Q_KEY); }
  btnSaveQuestion.addEventListener("click", saveQuestion);
  btnClearQuestion.addEventListener("click", clearQuestion);
  qInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ e.preventDefault(); saveQuestion(); } });

  /* Modal */
  function openModal(cardNo, extraLine=""){
    const info = CARD_INFO[cardNo] || { ko:"(ì •ë³´ ì—†ìŒ)", en:"", kw:[] };
    modalImg.src = imgSrc(cardNo);
    modalTitle.textContent = `${cardNo}. ${info.ko}`;
    modalSub.textContent = `${info.en}${extraLine ? " Â· " + extraLine : ""}`;

    modalChips.innerHTML = "";
    (info.kw || []).forEach(k=>{
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = k;
      modalChips.appendChild(chip);
    });

    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
  }
  btnCloseModal.addEventListener("click", closeModal);
  btnOkModal.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

  function clearStageOnly(){
    grid.innerHTML = "";
    chainRow.innerHTML = "";
    chainTitle.textContent = "ì²´ì¸";
    chainMeta.textContent = "";
    chainBox.style.display = "none";
    gt = null;
    layoutGrid(); // ë¹ˆ í™”ë©´ì—ì„œë„ ë ˆì´ì•„ì›ƒ ìœ ì§€
  }

  function getLayout(){
    if(mode === "gt") return { cols: 9, rows: 4 };
    if(mode === "9")  return { cols: 3, rows: 3 };
    return { cols: Number(mode), rows: 1 };
  }

  /* âœ… ì—¬ë°±(ì¹¸) ìì²´ê°€ ìƒê¸°ì§€ ì•Šê²Œ â€œí”½ì…€ íŠ¸ë™â€ìœ¼ë¡œ ê³ ì • */
  function layoutGrid(){
    const { cols, rows } = getLayout();

    // chainBoxê°€ ë³´ì´ë©´ grid ë†’ì´ê°€ ì¤„ì–´ë“œë‹ˆ ì‹¤ì œ grid ì˜ì—­ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
    const gridW = grid.clientWidth;
    const gridH = grid.clientHeight;

    if(gridW <= 0 || gridH <= 0) return;

    // ì¹´ë“œ í­ í›„ë³´ (ê°€ë¡œë¡œ ê½‰ ì±„ìš°ëŠ” ê¸°ì¤€)
    const w1 = Math.floor(gridW / cols);

    // ì¹´ë“œ í­ í›„ë³´ (ì„¸ë¡œë¡œ ê½‰ ì±„ìš°ëŠ” ê¸°ì¤€) : height = width*AR
    const w2 = Math.floor((gridH / rows) / AR);

    // ë‘˜ ì¤‘ ë” ì‘ì€ ê±¸ë¡œ â€œì•ˆ ì˜ë¦¬ê³ , ëª¨ë‘ ë³´ì´ê²Œâ€
    let cw = Math.max(1, Math.min(w1, w2));
    let ch = Math.max(1, Math.floor(cw * AR));

    // ì„œë¸Œí”½ì…€ í‹ˆ ë°©ì§€ (ì •ìˆ˜ ë³´ì •)
    cw = Math.floor(cw);
    ch = Math.floor(ch);

    grid.style.gridTemplateColumns = `repeat(${cols}, ${cw}px)`;
    grid.style.gridTemplateRows    = `repeat(${rows}, ${ch}px)`;
  }

  function setMode(newMode){
    mode = newMode;

    [...spreadButtons.querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.dataset.mode === mode);
    });

    // ëª¨ë“œ ë°”ê¿¨ì„ ë•ŒëŠ” í•­ìƒ â€œì²« í™”ë©´ì²˜ëŸ¼â€ ë¹„ì›€
    clearStageOnly();

    // ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°(2í”„ë ˆì„)
    requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
  }

  function createCardEl(cardNo, label, onClick){
    const el = document.createElement("div");
    el.className = "card";

    const img = document.createElement("img");
    img.src = imgSrc(cardNo);
    img.alt = `Card ${cardNo}`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = label;

    el.appendChild(img);
    el.appendChild(badge);
    el.addEventListener("click", onClick);
    return el;
  }

  function renderBasic(cards){
    grid.innerHTML = "";
    cards.forEach((no, idx)=>{
      grid.appendChild(createCardEl(no, `${idx+1}`, ()=> openModal(no)));
    });

    // ë Œë” ì´í›„ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°
    requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
  }

  function buildGrandTableau(cards36){
    const cardsByHouse = Array(37).fill(0);
    for(let house=1; house<=36; house++){
      cardsByHouse[house] = cards36[house-1];
    }
    return { cardsByHouse };
  }

  /* âœ… ì²´ì¸ ê¸¸ì´ â€œì„¤ì • ì—†ì´â€ : ë£¨í”„/ë²”ìœ„ ë°–/ì¤‘ë³µ í•˜ìš°ìŠ¤ ë‚˜ì˜¤ë©´ ì¢…ë£Œ */
  function buildHouseChain(gtState, startHouse){
    const chain = [];
    const seenHouses = new Set();
    let currentHouse = startHouse;

    while(true){
      if(currentHouse < 1 || currentHouse > 36) break;
      if(seenHouses.has(currentHouse)) break;
      seenHouses.add(currentHouse);

      const card = gtState.cardsByHouse[currentHouse];
      chain.push({ house: currentHouse, card });

      // ë‹¤ìŒ í•˜ìš°ìŠ¤ = í˜„ì¬ í•˜ìš°ìŠ¤ì— ë†“ì¸ ì¹´ë“œ ë²ˆí˜¸
      currentHouse = card;

      // í˜¹ì‹œ ì´ìƒ ë°ì´í„° ëŒ€ë¹„
      if(chain.length > 60) break;
    }
    return chain;
  }

  function renderChain(chain){
    chainRow.innerHTML = "";
    if(chain.length === 0){
      chainTitle.textContent = "ì²´ì¸";
      chainMeta.textContent = "";
      return;
    }

    const start = chain[0];
    chainTitle.textContent = `ì²´ì¸ (ì‹œì‘: H${start.house})`;
    chainMeta.textContent = `ê¸¸ì´ ${chain.length} Â· H${start.house} â†’ H${start.card} â†’ â€¦`;

    chain.forEach((step)=>{
      const mini = document.createElement("div");
      mini.className = "mini";

      const img = document.createElement("img");
      img.src = imgSrc(step.card);
      img.alt = `Chain ${step.card}`;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `H${step.house}`;

      mini.appendChild(img);
      mini.appendChild(badge);

      mini.addEventListener("click", ()=> openModal(step.card, `ì²´ì¸: H${step.house}`));
      chainRow.appendChild(mini);
    });
  }

  function renderGrandTableau(gtState){
    grid.innerHTML = "";

    for(let house=1; house<=36; house++){
      const cardNo = gtState.cardsByHouse[house];
      const el = createCardEl(cardNo, `H${house}`, (ev)=>{
        ev.stopPropagation();

        document.querySelectorAll(".card.selected").forEach(x=>x.classList.remove("selected"));
        el.classList.add("selected");

        // âœ… í´ë¦­ í›„ì—ë§Œ ì²´ì¸ í‘œì‹œ
        if(chainBox.style.display !== "block"){
          chainBox.style.display = "block";
          // ì²´ì¸ ìƒê¸°ë©´ grid ë†’ì´ê°€ ë³€í•˜ë¯€ë¡œ ì¬ê³„ì‚°
          requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
        }

        const chain = buildHouseChain(gtState, house);
        renderChain(chain);

        openModal(cardNo, `í•˜ìš°ìŠ¤ H${house}`);
      });

      grid.appendChild(el);
    }

    requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
  }

  function draw(){
    clearStageOnly(); // ë½‘ê¸° ì „ í™”ë©´ ì •ë¦¬

    if(mode === "gt"){
      const cards = take(36);
      gt = buildGrandTableau(cards);
      renderGrandTableau(gt);
      return;
    }

    const n = Number(mode);
    renderBasic(take(n));
  }

  // ì´ë²¤íŠ¸
  spreadButtons.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    setMode(btn.dataset.mode);
  });

  btnDraw.addEventListener("click", draw);
  btnShuffle.addEventListener("click", ()=> freshDeck());
  btnClear.addEventListener("click", ()=> clearStageOnly());

  window.addEventListener("resize", ()=>{
    requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
  });

  // ì´ˆê¸°í™”
  (async function init(){
    loadQuestion();
    freshDeck();
    await autoDetectBasePath();
    setMode("1"); // âœ… ì²« í™”ë©´ ì¹´ë“œ ì•ˆ ë³´ì„ ìœ ì§€
    // ì²« ë ˆì´ì•„ì›ƒ ê³„ì‚°
    requestAnimationFrame(()=>{ layoutGrid(); requestAnimationFrame(layoutGrid); });
  })();
</script>
</body>
</html>
